library(sf)
library(dplyr)
library(DatawRappr)
library(dotenv)

#EATON
# Load  GeoJSON from URL
eaton_url <- "https://services1.arcgis.com/jUJYIo9tSA7EHvfZ/arcgis/rest/services/DINS_2025_Eaton_Public_View/FeatureServer/0/query?where=0%3D0&objectIds=&geometry=&geometryType=esriGeometryPolygon&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&relationParam=&returnGeodetic=false&outFields=*&returnGeometry=true&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&defaultSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&collation=&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnTrueCurves=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pgeojson&token="
eaton <- st_read(eaton_url)

# Split by the 'damage' attribute
split_eaton <- eaton %>%
  group_by(DAMAGE) %>%
  group_split()

# Export each split layer to a separate GeoJSON file
lapply(seq_along(split_eaton), function(i) {
  damage_name <- unique(split_eaton[[i]]$DAMAGE)  # Get the unique damage name
  sanitized_name <- gsub("[^[:alnum:]_]", "_", damage_name)  # Replace non-alphanumeric characters with underscores
  st_write(
    split_eaton[[i]], 
    paste0("output/eaton/", sanitized_name, "_damage.geojson"),
    append = FALSE  # Overwrite the file if it exists
  )
})

# PALISADES
# Load  GeoJSON from URL
palisades_url <- "https://services1.arcgis.com/jUJYIo9tSA7EHvfZ/arcgis/rest/services/DINS_2025_Palisades_Public_View/FeatureServer/0/query?where=0%3D0&objectIds=&geometry=&geometryType=esriGeometryPolygon&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&relationParam=&returnGeodetic=false&outFields=*&returnGeometry=true&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&defaultSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&collation=&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnTrueCurves=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pgeojson&token="
palisades <- st_read(palisades_url)

# Split by the 'damage' attribute
split_palisades <- palisades %>%
  group_by(DAMAGE) %>%
  group_split()

# Export each split layer to a separate GeoJSON file
lapply(seq_along(split_palisades), function(i) {
  damage_name <- unique(split_palisades[[i]]$DAMAGE)  # Get the unique damage name
  sanitized_name <- gsub("[^[:alnum:]_]", "_", damage_name)  # Replace non-alphanumeric characters with underscores
  st_write(
    split_palisades[[i]], 
    paste0("output/palisades/", sanitized_name, "_damage.geojson"),
    append = FALSE  # Overwrite the file if it exists
  )
})

# Checking each main file to make sure it changed by creating a bar chart
damage_summary_palisades <- palisades %>%
  group_by(DAMAGE) %>%
  summarize(count = n(), .groups = "drop")

damage_summary_eaton <- eaton %>%
  group_by(DAMAGE) %>%
  summarize(count = n(), .groups = "drop")

# Get current date and time in UTC
current_datetime_utc <- Sys.time()

# Convert UTC to Eastern Time
current_datetime_eastern <- with_tz(current_datetime_utc, "America/New_York")

# Round the datetime to the nearest hour
rounded_datetime <- round_date(current_datetime_eastern, "hour")

# Format the date and time
formatted_datetime <- format(rounded_datetime, "%B %e, %Y at %l %p ET.")

# Load the .env file
tryCatch({
  load_dot_env()
}, error = function(e) {
  # Do nothing
})
dw_api_key <- Sys.getenv("DW_API_KEY")

# Make the Datawrapper
datawrapper_auth(api_key = dw_api_key)
dw_data_to_chart(damage_summary_palisades, "WfBZU", api_key = dw_api_key)

dw_edit_chart(
  chart_id = "WfBZU",
  api_key = dw_api_key,
  title = "Damage in Palisades",
  byline = "Taylor Johnston / CBS News",
  annotate = paste(
    "Note: Last updated", formatted_datetime),
  folderId = "287712"
)

# Publish the chart
dw_publish_chart(chart_id = "WfBZU")

# Make the Datawrapper
datawrapper_auth(api_key = dw_api_key)
dw_data_to_chart(damage_summary_eaton, "Fufx8", api_key = dw_api_key)

dw_edit_chart(
  chart_id = "Fufx8",
  api_key = dw_api_key,
  title = "Damage in Eaton",
  byline = "Taylor Johnston / CBS News",
  annotate = paste(
    "Note: Last updated", formatted_datetime),
  folderId = "287712"
)

# Publish the chart
dw_publish_chart(chart_id = "Fufx8")